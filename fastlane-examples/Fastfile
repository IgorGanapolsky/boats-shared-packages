default_platform(:ios)

platform :ios do
  desc "Build and upload iOS app to TestFlight"
  lane :beta do
    # Install shared packages from the artifacts
    sh("npm install ../boats-core-*.tgz ../boats-hooks-*.tgz")
    
    # Update app.json with new version
    increment_version_number_in_xcodeproj(
      version_number: ENV["APP_VERSION"] || "1.0.0"
    )
    increment_build_number(
      build_number: ENV["BUILD_NUMBER"] || "1"
    )
    
    # Build the iOS app
    build_app(
      workspace: "BoatsMobile.xcworkspace",
      scheme: "BoatsMobile",
      export_method: "app-store"
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end
end

platform :android do
  desc "Build and upload Android app to Google Play"
  lane :beta do
    # Install shared packages from the artifacts
    sh("npm install ../boats-core-*.tgz ../boats-hooks-*.tgz")
    
    # Update version in app.json
    increment_version_code(
      gradle_file_path: "android/app/build.gradle",
      version_code: ENV["BUILD_NUMBER"].to_i || 1
    )
    
    # Build the Android app
    gradle(
      task: "clean assembleRelease",
      project_dir: "android/"
    )
    
    # Upload to Google Play
    upload_to_play_store(
      track: "beta",
      release_status: "draft"
    )
  end
end
